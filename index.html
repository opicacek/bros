<html>
	<head>
		<title>Bros</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

		<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script> /-->
		<!-- <script type="text/javascript" src="socketio/socketio.js"></script> /-->
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<!-- <script type="text/javascript" src="js/main.js"></script> /-->
		<script type="text/javascript">
			function play() {
				
				// Frame rate definition
				var fps = 50;
				var now;
				var then = Date.now();
				var interval = 1000 / fps;
				var delta;
				
				// Init
				var c = document.getElementById('c');
				var ctx = c.getContext('2d');

				c.width = 760;
				c.height = 400;

				var screen_w = c.width;
				var screen_h = c.height;
				
				//
				var my_bro_pos = [];
				my_bro_pos.push( Math.floor(Math.random()*screen_w), Math.floor(Math.random()*screen_h) );

				var id_time = new Date().getTime();
				var id_random = Math.floor(Math.random()*100000);
				var my_bro_id = id_time + "" + id_random;
				
				//
				c.onmousedown = mouseDown;
				function mouseDown(e) {
					if (e.button == 0) { // left click
						var mouse_x = event.clientX-document.documentElement.scrollLeft-c.offsetLeft;
						var mouse_y = event.clientY-document.documentElement.scrollTop-c.offsetTop;
						console.log(mouse_x, mouse_y);
						//TODO get click position
					}
				}

				function drawWorld() {
					// background 
					ctx.fillStyle = "rgb(255, 255, 255)";
					ctx.fillRect(0, 0, screen_w, screen_h);
				}
				
				function drawBros(bro_list) {
					
					//for (var i = 0; i < bro_list.length; i++) {
					//for (var i = 0; i < bro_list.length; i++) {
					for (var bro_key in bro_list) {
						var centerX = bro_list[bro_key][0];
						var centerY = bro_list[bro_key][1];
						var radius = 10;

						ctx.beginPath();
						ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
						//console.log(centerX, centerY);
						ctx.fillStyle = "rgb(255, 0, 0)";
						if (bro_key == my_bro_id) {
							ctx.fillStyle = "rgb(0, 255, 0)";
						}
						
						ctx.fill();
					}
				}

				// Bro to server
				var bro_list;
				/*
				bro_list.push({bro_id: "123", bro_pos: [50, 160]});
				bro_list.push({bro_id: "456", bro_pos: [230, 300]});
				bro_list.push({bro_id: my_bro_id, bro_pos: [500, 260]});
				*/
				
				var socket = io.connect('192.168.2.102'); //TODO
				/*socket.on('bro_list', function (data) {
					console.log("got Bros from server:", data);
					socket.emit('bro', {bro_id: my_bro_id, bro_pos: [500, 260]});
				});*/
				
				// get positions of all Bros
				socket.on('bro_list', function (data) {
					console.log("got Bros from server:", data);
					bro_list = data;
				});

				function updateBros() {
					// send my_bro position
					console.log("informations send to server");
					socket.emit('bro', {bro_id: my_bro_id, bro_pos: my_bro_pos});

					/*
					console.log("informations send to server");
					$.post('server/', {bro_id: my_bro_id, bro_pos: my_bro_pos});
					
					// get positions of all Bros
					$.get('server/', {}, function(response) {
						console.log("got Bros from server:", response);
						bro_list = response;
					});
					*/
					setTimeout(updateBros, 1000);
				}
				updateBros();
				
				// draw loop
				var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
				window.requestAnimationFrame = requestAnimationFrame;
				
				function drawLoop(e) {

					requestAnimationFrame(drawLoop);
					
					now = Date.now();
					delta = now - then;
					
					if (delta > interval) {

						drawWorld();
									
						drawBros(bro_list);
					
						// update time stuffs
						then = now - (delta % interval);		
					}
					
				}
				drawLoop();

			}
		</script>
		<style type="text/css">
			body {
				background-color: #000;
				margin: 0px;
				padding: 0px;
				text-align: center;
				font: 70%/1.5 Verdana, Tahoma, Arial, Helvetica, sans-serif;
				color: #ddd;
			}
			canvas {
				outline: 0;
				border: 0px;
				margin-left: auto;
				margin-right: auto;
			}
			a {
				color: #55DD55;
				text-decoration: none;
			}
			a:hover {
				color: #11AA11; 
			}
			a img {
				border: none;
			}
		</style>
	</head>

	<body onload="play()">
		<canvas id="c" width="760" height="400" ></canvas>

		<p><b>Controls:</b> Use mouse to move your Bro.</p>

		<div>Coding: <b>Opi Danihelka</b> &amp; <b>Martin Br√°zdil</b></div>
		<p><br/><b>Opi-games</b> 2013<br/>for more games visit: <a href="http://jan.danihelka.net">jan.danihelka.net</a></p>

	</body>
</html>
